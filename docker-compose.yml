services:
  vector-db:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:6333/readyz"]
      interval: 5s
      timeout: 2s
      retries: 20
      start_period: 6s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - app-network

  learning-mcp:
    container_name: learning-mcp
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      - MCP_TRANSPORT=http
      - MCP_PORT=8013
      - JOB_PORT=8014
      - VECTOR_DB_URL=http://vector-db:6333
      - OLLAMA_HOST=http://host.docker.internal:11434
      - USE_AUTOGEN=1
      - AUTOGEN_LOG_LEVEL=minimal
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_PERSONAL_ACCESS_TOKEN}
    ports:
      - "8013:8013"  # MCP server (SSE)
      - "8014:8014"  # Job server (HTTP REST)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8014/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      - ./src:/app/src:ro
      - ./config:/app/config:ro
      - ./data:/app/data:ro
      - ./state:/app/state
    depends_on:
      vector-db:
        condition: service_started
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - app-network

volumes:
  qdrant_data:

networks:
  app-network:
    driver: bridge